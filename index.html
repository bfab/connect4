<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Connect Four P2P (Pluggable Backend)</title>
  <style>
    body{font-family:sans-serif;text-align:center}
    #board{display:grid;grid-template-columns:repeat(7,60px);gap:5px;margin:20px auto}
    .cell{width:60px;height:60px;border-radius:50%;border:2px solid #333;background:#eee;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .cell.Red{background:red}.cell.Yellow{background:yellow}
    #info{margin:10px;font-weight:bold}
    .turn{font-weight:bold;font-size:1.2em}
    .turn.Red{color:red}.turn.Yellow{color:gold}
    button{padding:5px 10px;margin:5px;cursor:pointer}
    input#shortLink{width:80%;padding:5px;margin-top:5px;}
  </style>

  <script src="aes256.js"></script>

  <!-- libraries required by simplepeer-based implementation -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script> -->

  <!-- libraries required by peerjs-based implementation -->
  <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>

</head>
<body>
  <h1>Connect Four (Pluggable P2P)</h1>
  <p id="info"></p>
  <div id="board"></div>
  <button id="restartBtn">ðŸ”„ Restart Game</button>
  
  <script type="module">
    import { initNetwork } from "./network.peerjs.js";

    const ROWS=6, COLS=7;
    let state={board:Array.from({length:ROWS},()=>Array(COLS).fill("")), turn:"Red", winner:""};
    let player="", opponent="";

    const boardDiv=document.getElementById("board");
    for(let r=0;r<ROWS;r++){
      for(let c=0;c<COLS;c++){
        const cell=document.createElement("div");
        cell.className="cell";
        cell.dataset.row=r;
        cell.dataset.col=c;
        cell.onclick=()=>dropCoin(c);
        boardDiv.appendChild(cell);
      }
    }

    function render(){
      document.querySelectorAll(".cell").forEach(cell=>{
        const r=+cell.dataset.row, c=+cell.dataset.col;
        cell.className="cell "+(state.board[r][c]||"");
      });
      const info=document.getElementById("info");
      if(state.winner){
        info.innerHTML = state.winner==="draw" ? 
          `<span class="turn">Draw!</span>` :
          `<span class="turn ${state.winner}">${state.winner} wins!</span>`;
      } else {
        info.innerHTML = `Turn: <span class="turn ${state.turn}">${state.turn}</span> | You are <span class="turn ${player}">${player}</span>`;
      }
    }

    function dropCoin(col){
      if(state.winner || state.turn !== player) return;
      for(let r=ROWS-1;r>=0;r--){
        if(!state.board[r][col]){
          state.board[r][col]=player;
          checkWin(r,col);
          state.turn=opponent;
          net.send(state);
          render();
          return;
        }
      }
    }

    function checkWin(row,col){
      const p=state.board[row][col];
      if(!p) return;
      const dirs=[[0,1],[1,0],[1,1],[1,-1]];
      for(let [dr,dc] of dirs){
        let count=1;
        for(let k=1;k<4;k++){
          const r=row+dr*k, c=col+dc*k;
          if(r>=0 && r<ROWS && c>=0 && c<COLS && state.board[r][c]===p) count++;
          else break;
        }
        for(let k=1;k<4;k++){
          const r=row-dr*k, c=col-dc*k;
          if(r>=0 && r<ROWS && c>=0 && c<COLS && state.board[r][c]===p) count++;
          else break;
        }
        if(count>=4){ state.winner=p; return; }
      }
      if(state.board.every(r=>r.every(c=>c))) state.winner="draw";
    }

    document.getElementById("restartBtn").addEventListener("click", restartGame);
    function restartGame(){
      state={board:Array.from({length:ROWS},()=>Array(COLS).fill("")), turn:"Red", winner:""};
      net.send(state);
      render();
    }

    // --- Networking ---
    let net;

    const callback = (remoteState) => {
        state = remoteState;
        render();
      }

    async function decryptPeerJSParams() {
        let password = localStorage.getItem('connectionPassword') || '';
        while (!password) {
          password = window.prompt('Enter connection password');
          if (password) {
            try { localStorage.setItem('connectionPassword', password); } catch(e) {}
          }
        }
        const encryptedParams = "0POUjA95qzpYeUw323sebw==:7pf4lzZNptd/TYcd:Z38yx9QaaxJMjNiuEHdUSTLITGCKi8aGnfUneEWmF+SMjjDqGqhB3eFXZA==";
        
        try {
            const configParamsString = await AES256.decrypt(password, encryptedParams);
            return getPeerJSParamsFromString(configParamsString);
        } catch (err) {
            localStorage.removeItem('connectionPassword');
            alert("Error decrypting peerjs params; ensure you have the correct password.");
            return null;
        }
    }

    function getPeerJSParamsFromString(configParamsString) {
        const [ hostAndPort, path ] = configParamsString.split("/");
        const [ host, port ] = hostAndPort.split(":");
        return { host, port, path }
    }

    (async () => {
      const peerServerConfig = await decryptPeerJSParams();
      net = await initNetwork(callback, peerServerConfig);

      await net.ready;
      player = net.isHost ? "Red" : "Yellow";
      opponent = player==="Red"?"Yellow":"Red";
      console.log("Connected. Host?", net.isHost);
      render();
    })();

    render();
  </script>
</body>
</html>
